pipeline {
	agent any

	environment {
		DOCKER_IMG = "puyt"
		DOCKER_TAG = "latest"
		DEPLOY_NAME = "node-app"
		KUBE_DEPLOY = "kube-Mark-10.2/deployment.yml"
		KUBE_SERV = "kube-Mark-10.2/service.yml"
	}

	stages {
		stage('checkout code') {
			steps {
				checkout scm
			}
		}
		stage('Set Docker Env') {
            		steps {
                		script {
                    		// Re-evaluate Docker environment to ensure we're interacting with the correct Docker daemon
                    		sh 'eval $(minikube -p minikube docker-env)' // Replace this with your environment setup
               			 }
           		 }
       		 }
		stage('pull docker') {
			steps {
			   script {
				sh """
				   docker pull kamalsai33/puyt:latest
				   """
				}
			}
		}
		stage('deploy to kubernet') {
			steps {
				script {
				  sh """
              				echo "Current Directory Contents:"
              				ls -la
              				kubectl get svc
     		      			"""
				   sh """
				      kubectl apply -f ${KUBE_DEPLOY} -f ${KUBE_SERV}
				      kubectl rollout status deployment/${DEPLOY_NAME}
				      """
				}
			}
		}
	}

	post {
		success {
			echo 'pipeline complete'
		}
		failure {
			echo 'pipeline failed'
		}
	}
}


